<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimal Sankey Test</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; direction: rtl; }
        .sankey-link { opacity: 0.6; }
        .sankey-link:hover { opacity: 0.9; }
        .sankey-node { font-size: 12px; }
    </style>
</head>
<body>
    <h1>Minimal Sankey Test - Top Line Issue</h1>
    <div id="test-chart"></div>
    
    <script>
        // Test data with just a few hostages to isolate the issue
        const testData = {
            nodes: [
                { id: 'alive-oct7', name: ' -7.10', step: 1, index: 0 },
                { id: 'deceased-oct7', name: '驻专 -7.10', step: 1, index: 1 },
                { id: 'released-deal-living', name: '砖专专 注住拽 - ', step: 2, index: 2 },
                { id: 'released-deal-deceased', name: '砖专专 注住拽 - 驻专', step: 2, index: 3 },
                { id: 'released-military-living', name: '砖专专 爪注 - ', step: 2, index: 4 }
            ],
            links: [
                { source: 0, target: 2, value: 50, hostages: [] }, // alive-oct7 -> released-deal-living
                { source: 0, target: 4, value: 5, hostages: [] },  // alive-oct7 -> released-military-living
                { source: 1, target: 3, value: 2, hostages: [] }   // deceased-oct7 -> released-deal-deceased
            ]
        };
        
        // Set node values to match connected links
        testData.nodes.forEach(node => {
            node.value = 0;
            node.sourceLinks = [];
            node.targetLinks = [];
        });
        
        testData.links.forEach(link => {
            const sourceNode = testData.nodes[link.source];
            const targetNode = testData.nodes[link.target];
            
            sourceNode.sourceLinks.push(link);
            targetNode.targetLinks.push(link);
            sourceNode.value += link.value;
            link.source = sourceNode;
            link.target = targetNode;
        });
        
        // Terminal nodes get value from incoming links
        testData.nodes.forEach(node => {
            if (node.sourceLinks.length === 0) {
                node.value = node.targetLinks.reduce((sum, link) => sum + link.value, 0);
            }
        });
        
        console.log(' TEST-DATA: Node values:', testData.nodes.map(n => `${n.id}: ${n.value}`));
        console.log(' TEST-DATA: Link values:', testData.links.map(l => `${l.source.id}->${l.target.id}: ${l.value}`));
        
        // Setup SVG
        const width = 800;
        const height = 400;
        const margin = { top: 20, right: 50, bottom: 20, left: 50 };
        
        const svg = d3.select('#test-chart')
            .append('svg')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom)
            .append('g')
            .attr('transform', `translate(${margin.left},${margin.top})`);
        
        // Setup Sankey
        const sankey = d3.sankey()
            .nodeWidth(20)
            .nodePadding(10)
            .extent([[0, 0], [width, height]])
            .nodeAlign(d3.sankeyJustify)
            .iterations(10);
        
        // Apply RTL positioning
        testData.nodes.forEach(node => {
            if (node.step === 1) {
                node.x0 = width * 0.75;
                node.x1 = node.x0 + 20;
            } else if (node.step === 2) {
                node.x0 = 50;
                node.x1 = node.x0 + 20;
            }
        });
        
        // Process with Sankey
        sankey(testData);
        
        console.log(' TEST-SANKEY: Post-processing link positions:');
        testData.links.forEach(link => {
            console.log(`  ${link.source.id}->${link.target.id}: y0=${link.y0} y1=${link.y1} width=${link.width}`);
        });
        
        // Render links
        const linkGenerator = d3.sankeyLinkHorizontal();
        
        svg.selectAll('.sankey-link')
            .data(testData.links)
            .enter()
            .append('path')
            .attr('class', 'sankey-link')
            .attr('d', linkGenerator)
            .style('stroke', '#999')
            .style('stroke-width', d => Math.max(1, d.width))
            .style('fill', 'none')
            .on('mouseover', function(event, d) {
                console.log(` TEST-HOVER: ${d.source.id}->${d.target.id} width=${d.width} y0=${d.y0} y1=${d.y1}`);
            });
        
        // Render nodes
        svg.selectAll('.sankey-node')
            .data(testData.nodes)
            .enter()
            .append('rect')
            .attr('class', 'sankey-node')
            .attr('x', d => d.x0)
            .attr('y', d => d.y0)
            .attr('height', d => d.y1 - d.y0)
            .attr('width', d => d.x1 - d.x0)
            .style('fill', '#666')
            .style('stroke', '#000');
        
        // Node labels
        svg.selectAll('.node-label')
            .data(testData.nodes)
            .enter()
            .append('text')
            .attr('class', 'node-label')
            .attr('x', d => d.step === 1 ? d.x0 - 6 : d.x1 + 6)
            .attr('y', d => (d.y0 + d.y1) / 2)
            .attr('dy', '0.35em')
            .style('text-anchor', d => d.step === 1 ? 'end' : 'start')
            .text(d => d.name);
        
        console.log(' TEST-COMPLETE: Minimal test rendered. Check for flat lines in the visualization.');
    </script>
</body>
</html>