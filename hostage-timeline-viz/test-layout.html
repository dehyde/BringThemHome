<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Layout Test - Positioning Fixes</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f5f5f5; }
        .test-container { background: white; margin: 20px 0; border: 2px solid #ccc; }
        #timeline-container { width: 100%; height: 800px; border: 1px solid #999; }
        .debug-info { background: #f9f9f9; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .console-output { background: #1a1a1a; color: #00ff00; padding: 10px; font-family: 'Courier New', monospace; height: 300px; overflow-y: auto; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>Timeline Layout Debug Test</h1>
    
    <div class="debug-info">
        <h3>Testing the positioning fixes:</h3>
        <ul>
            <li>✅ Fixed lane height calculation consistency</li>
            <li>✅ Fixed timeline axis positioning</li>
            <li>✅ Added dynamic SVG resizing</li>
            <li>✅ Added debug lane boundaries</li>
        </ul>
        <button onclick="runLayoutTest()">Run Layout Test</button>
        <button onclick="clearDebug()">Clear Debug</button>
    </div>
    
    <div class="test-container">
        <div id="timeline-container"></div>
    </div>
    
    <div class="debug-info">
        <h4>Console Output:</h4>
        <div class="console-output" id="console-output"></div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="js/data-processor.js"></script>
    <script src="js/timeline-core.js"></script>
    <script src="js/lane-manager.js"></script>
    
    <script>
        // Console output capture
        const consoleDiv = document.getElementById('console-output');
        const originalLog = console.log;
        const originalError = console.error;
        
        function logToDiv(type, ...args) {
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            consoleDiv.innerHTML += `<div>[${type}] ${message}</div>`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            logToDiv('LOG', ...args);
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            logToDiv('ERROR', ...args);
        };

        let timeline, laneManager, processedData;

        async function runLayoutTest() {
            try {
                console.log('=== STARTING LAYOUT TEST ===');
                
                // Clear previous test
                d3.select('#timeline-container').selectAll('*').remove();
                
                // Load and process data
                console.log('Loading CSV data...');
                const response = await fetch('data/hostages-from-kan.csv');
                const csvText = await response.text();
                const dataProcessor = new DataProcessor();
                processedData = dataProcessor.process(csvText);
                
                console.log(`Processed ${processedData.length} hostages`);
                
                // Initialize timeline core
                console.log('Initializing timeline core...');
                timeline = new TimelineCore('timeline-container');
                timeline.initialize();
                timeline.updateTimeline(processedData);
                
                const initialDimensions = timeline.getDimensions();
                console.log('Initial timeline dimensions:', initialDimensions);
                
                // Initialize and process lanes
                console.log('Setting up lane manager...');
                laneManager = new LaneManager(timeline);
                const sortedData = laneManager.processData(processedData);
                
                console.log('=== LANE STATISTICS (BEFORE RENDERING) ===');
                laneManager.logLaneStats();
                
                // Render lanes
                console.log('Rendering lanes...');
                laneManager.renderLanes();
                
                console.log('=== LANE STATISTICS (AFTER RENDERING) ===');
                laneManager.logLaneStats();
                
                // Add debug boundaries
                console.log('Adding debug lane boundaries...');
                laneManager.debugLaneLayout();
                
                console.log('=== FINAL TIMELINE DIMENSIONS ===');
                const finalDimensions = timeline.getDimensions();
                console.log('Final dimensions:', finalDimensions);
                
                // Test some individual hostage positions
                console.log('=== TESTING INDIVIDUAL HOSTAGE POSITIONS ===');
                const testHostages = sortedData.slice(0, 5);
                testHostages.forEach(hostage => {
                    const y = laneManager.getHostageY(hostage);
                    console.log(`${hostage['Hebrew Name']} (${hostage.laneId}): Y=${y}px, lanePosition=${hostage.lanePosition}`);
                });
                
                console.log('=== LAYOUT TEST COMPLETE ===');
                
            } catch (error) {
                console.error('Layout test failed:', error);
            }
        }
        
        function clearDebug() {
            consoleDiv.innerHTML = '';
        }

        // Auto-run test
        window.addEventListener('load', () => {
            setTimeout(runLayoutTest, 500);
        });
    </script>
</body>
</html>